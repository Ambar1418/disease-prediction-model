# Render Deployment Configuration
# This file instructs Render how to build and start the application

services:
  - type: web
    name: hair-scalp-detector-api
    runtime: python
    pythonVersion: 3.11
    plan: starter # Change to 'standard' or higher for better performance

    # Build command: installs LFS, dependencies, migrations, and static files
    buildCommand: |
      set -e
      echo "Installing Git LFS..."
      curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash
      apt-get update -qq
      apt-get install -y git-lfs 2>&1 | grep -v "done\|Setting up"
      git lfs install
      echo "Pulling LFS objects..."
      git lfs pull origin main 2>&1 || echo "LFS pull had issues, continuing..."

      echo "Installing dependencies..."
      cd required_files/minor
      pip install -q -r requirements.txt

      echo "Running migrations..."
      python manage.py migrate --noinput --settings=minor.settings_production 2>&1 || true

      echo "Collecting static files..."
      python manage.py collectstatic --noinput --settings=minor.settings_production

    # Start command: runs the Django development/production server
    startCommand: cd required_files/minor && gunicorn minor.wsgi:application --bind 0.0.0.0:$PORT --timeout 600 --workers 2

    # Environment variables
    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: minor.settings_production
      - key: SECRET_KEY
        sync: false
        # Add your SECRET_KEY value in Render dashboard (Settings > Environment)
      - key: DATABASE_URL
        sync: false
        # Optional: Add PostgreSQL connection string if using external database

    # Auto-deploy on push to main
    autoDeploy: true

    # Health check
    healthCheckPath: /
